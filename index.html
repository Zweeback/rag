<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <title>Alice – Archivator Assistant</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js" integrity="sha384-lbDiyZMhUlCT3VkOITkkpWra9EzbUN52yQ/iPaHyKA3P6J9/4EzHeJrvZCvSqaIg" crossorigin="anonymous"></script>
    <style>
      :root {
        color-scheme: light dark;
        font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: #0f1115;
        color: #e8eaed;
      }

      body {
        margin: 0;
        padding: 2rem;
        display: flex;
        justify-content: center;
      }

      main {
        width: min(640px, 100%);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        padding: 2rem;
        background: rgba(32, 33, 36, 0.8);
        border-radius: 24px;
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.3);
      }

      header {
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }

      #statusAvatar {
        width: 96px;
        height: 96px;
        border-radius: 50%;
        background: linear-gradient(135deg, #9aa0a6, #5f6368);
        display: grid;
        place-items: center;
        font-size: 2rem;
        color: rgba(0, 0, 0, 0.6);
        transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
      }

      #statusAvatar::after {
        content: attr(data-state-label);
        font-size: 0.75rem;
        color: #e8eaed;
      }

      #statusAvatar[data-state='idle'] {
        background: linear-gradient(135deg, #9aa0a6, #5f6368);
        box-shadow: none;
      }

      #statusAvatar[data-state='listening'] {
        background: linear-gradient(135deg, #34a853, #0f9d58);
        transform: scale(1.05);
        box-shadow: 0 0 32px rgba(15, 157, 88, 0.6);
      }

      #statusAvatar[data-state='thinking'] {
        background: linear-gradient(135deg, #fbbc04, #f29900);
        transform: scale(1.02);
        box-shadow: 0 0 32px rgba(251, 188, 4, 0.6);
      }

      #statusAvatar[data-state='speaking'] {
        background: linear-gradient(135deg, #4285f4, #1a73e8);
        transform: scale(1.05);
        box-shadow: 0 0 32px rgba(26, 115, 232, 0.6);
      }

      #micButton,
      #sendButton,
      #enterVrButton {
        padding: 0.75rem 1.5rem;
        border-radius: 999px;
        border: none;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        background: linear-gradient(135deg, #ff8a65, #ff7043);
        color: #121212;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      #micButton[disabled] {
        cursor: not-allowed;
        opacity: 0.4;
        box-shadow: none;
      }

      #micButton:hover:not([disabled]),
      #sendButton:hover,
      #enterVrButton:hover:not([disabled]) {
        transform: translateY(-1px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      }

      #log {
        max-height: 320px;
        overflow-y: auto;
        padding: 1rem;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.05);
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .log-entry {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.03);
      }

      .log-entry[data-role='user'] {
        border-left: 4px solid #ff8a65;
      }

      .log-entry[data-role='assistant'] {
        border-left: 4px solid #1a73e8;
      }

      .log-entry[data-role='error'] {
        border-left: 4px solid #ea4335;
        background: rgba(234, 67, 53, 0.15);
      }

      #vrSection {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding: 1.25rem;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.05);
      }

      #vrPreviewContainer {
        position: relative;
        width: 100%;
        height: 320px;
        border-radius: 16px;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.4);
      }

      a-scene.embedded {
        width: 100% !important;
        height: 100% !important;
      }

      form {
        display: flex;
        gap: 0.75rem;
      }

      input[type='text'] {
        flex: 1;
        padding: 0.75rem 1rem;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.35);
        color: inherit;
        font-size: 1rem;
      }

      input[type='text']::placeholder {
        color: rgba(232, 234, 237, 0.5);
      }

      .hint {
        font-size: 0.85rem;
        color: rgba(232, 234, 237, 0.65);
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <div id="statusAvatar" data-state="idle" data-state-label="Bereit">🎧</div>
        <div>
          <h1>Alice – Dein Archivator</h1>
          <p class="hint">
            Drücke auf das Mikrofon, sprich deinen Befehl und warte auf die Antwort. Alternativ kannst du eine Nachricht tippen.
          </p>
        </div>
      </header>

      <button id="micButton" type="button">🎤 Aufnahme starten</button>

      <section>
        <h2>Verlauf</h2>
        <div id="log" aria-live="polite"></div>
      </section>

      <section id="vrSection">
        <h2>Meta Quest VR-Modus</h2>
        <p class="hint">
          Setze dein Meta Quest Headset auf und tippe auf „In VR öffnen“, um Alice in einer immersiven Umgebung zu erleben.
        </p>
        <div id="vrPreviewContainer">
          <a-scene id="aliceScene" embedded vr-mode-ui="enabled: true">
            <a-entity geometry="primitive: circle; radius: 6" rotation="-90 0 0" material="color: #1f2933; opacity: 0.9"></a-entity>
            <a-entity id="vrAvatar" geometry="primitive: sphere; radius: 0.35" position="0 1.5 -1.5" material="color: #5f6368; emissive: #1b1f27; emissiveIntensity: 0.4"></a-entity>
            <a-entity geometry="primitive: torus; radius: 1.6; radiusTubular: 0.02" position="0 1.2 -1.5" material="color: #4a5568; opacity: 0.6"></a-entity>
            <a-entity id="vrPanel" geometry="primitive: plane; width: 1.8; height: 1.1" position="0 1.45 -2.2" material="color: #10131a; opacity: 0.85"></a-entity>
            <a-entity id="vrText" text="value: Willkommen im Archivator VR-Studio.; width: 1.6; wrapCount: 32; color: #e8eaed; align: center" position="0 1.5 -2.19"></a-entity>
            <a-entity light="type: ambient; intensity: 0.4; color: #ffffff"></a-entity>
            <a-entity light="type: point; intensity: 1.1; distance: 8; color: #4fc3f7" position="1.2 2.5 -1.2"></a-entity>
            <a-sky color="#05070c"></a-sky>
          </a-scene>
        </div>
        <button id="enterVrButton" type="button">In VR öffnen</button>
        <p class="hint">
          Der VR-Modus nutzt WebXR. Meta Quest Browser unterstützt WebXR über HTTPS – verwende beim Deployment eine sichere Web-App-URL.
        </p>
      </section>

      <form id="textForm">
        <input id="textInput" type="text" autocomplete="off" placeholder="Nachricht an Alice schreiben" />
        <button id="sendButton" type="submit">Senden</button>
      </form>
    </main>

    <script>
      (function () {
        const micButton = document.getElementById('micButton');
        const textForm = document.getElementById('textForm');
        const textInput = document.getElementById('textInput');
        const log = document.getElementById('log');
        const avatar = document.getElementById('statusAvatar');
        const vrButton = document.getElementById('enterVrButton');
        const vrScene = document.getElementById('aliceScene');
        const vrText = document.getElementById('vrText');
        const vrAvatar = document.getElementById('vrAvatar');

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isListening = false;
        let selectedVoice = null;
        const defaultVrGreeting = 'Alice: Willkommen im Archivator VR-Studio.';
        let vrMessages = vrText ? [defaultVrGreeting] : [];

        const stateLabels = {
          idle: 'Bereit',
          listening: 'Zuhören',
          thinking: 'Nachdenken',
          speaking: 'Antworten'
        };

        const vrStateConfig = {
          idle: { color: '#5f6368', emissive: '#1b1f27', intensity: 0.4, scale: '1 1 1' },
          listening: { color: '#0f9d58', emissive: '#34a853', intensity: 0.8, scale: '1.12 1.12 1.12' },
          thinking: { color: '#f29900', emissive: '#fbbc04', intensity: 0.8, scale: '1.08 1.08 1.08' },
          speaking: { color: '#1a73e8', emissive: '#4285f4', intensity: 0.9, scale: '1.15 1.15 1.15' }
        };

        if (vrText && vrMessages.length) {
          vrText.setAttribute('text', 'value', vrMessages.join('\n'));
        }

        function updateVrState(state) {
          if (!vrAvatar) {
            return;
          }
          const config = vrStateConfig[state] || vrStateConfig.idle;
          vrAvatar.setAttribute(
            'material',
            'color: ' + config.color + '; emissive: ' + config.emissive + '; emissiveIntensity: ' + config.intensity
          );
          vrAvatar.setAttribute('scale', config.scale);
        }

        function updateVrLog(role, message) {
          if (!vrText) {
            return;
          }
          const labels = {
            user: 'Du',
            assistant: 'Alice',
            error: 'System'
          };
          const label = labels[role] || 'System';
          const cleanMessage = String(message || '').replace(/\s+/g, ' ').trim();
          if (!cleanMessage) {
            return;
          }
          vrMessages.push(label + ': ' + cleanMessage);
          if (vrMessages.length > 4) {
            vrMessages = vrMessages.slice(-4);
          }
          vrText.setAttribute('text', 'value', vrMessages.join('\n'));
        }

        updateVrState('idle');

        function setAvatarState(state) {
          avatar.dataset.state = state;
          avatar.setAttribute('data-state-label', stateLabels[state] || 'Bereit');
          updateVrState(state);
        }

        function logMessage(role, message) {
          const entry = document.createElement('div');
          entry.className = 'log-entry';
          entry.dataset.role = role;

          const meta = document.createElement('strong');
          if (role === 'user') {
            meta.textContent = 'Du';
          } else if (role === 'assistant') {
            meta.textContent = 'Alice';
          } else {
            meta.textContent = 'Fehler';
          }

          const text = document.createElement('span');
          text.textContent = message;

          entry.appendChild(meta);
          entry.appendChild(text);
          log.appendChild(entry);
          log.scrollTop = log.scrollHeight;
          updateVrLog(role, message);
        }

        function sendToServer(text) {
          if (!text) {
            return;
          }

          logMessage('user', text);
          setAvatarState('thinking');

          google.script.run
            .withSuccessHandler(onReply)
            .withFailureHandler(onError)
            .processVoiceCommand(text);
        }

        function onReply(response) {
          const message = typeof response === 'string' ? response : JSON.stringify(response);
          logMessage('assistant', message);
          speak(message);
        }

        function onError(err) {
          const message = err && err.message ? err.message : 'Ein unbekannter Fehler ist aufgetreten.';
          logMessage('error', message);
          setAvatarState('idle');
        }

        function speak(text) {
          if (!('speechSynthesis' in window)) {
            setAvatarState('idle');
            return;
          }

          window.speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'de-DE';
          if (selectedVoice) {
            utterance.voice = selectedVoice;
          }

          utterance.onstart = function () {
            setAvatarState('speaking');
          };

          utterance.onend = function () {
            setAvatarState('idle');
          };

          utterance.onerror = function () {
            setAvatarState('idle');
          };

          window.speechSynthesis.speak(utterance);
        }

        function chooseVoice() {
          if (!('speechSynthesis' in window)) {
            return null;
          }

          const voices = window.speechSynthesis.getVoices();
          if (!voices.length) {
            return null;
          }

          const frenchVoice = voices.find((voice) => voice.lang && voice.lang.toLowerCase().startsWith('fr'));
          return frenchVoice || voices[0];
        }

        function handleRecognitionResult(event) {
          let transcript = '';
          for (let i = event.resultIndex; i < event.results.length; i++) {
            const result = event.results[i];
            if (result.isFinal) {
              transcript += result[0].transcript.trim();
            }
          }

          if (transcript) {
            sendToServer(transcript);
          } else {
            setAvatarState('idle');
          }
        }

        function startListening() {
          if (!recognition) {
            return;
          }

          recognition.start();
          isListening = true;
          micButton.textContent = '⏹️ Aufnahme stoppen';
          setAvatarState('listening');
        }

        function stopListening() {
          if (!recognition) {
            return;
          }

          recognition.stop();
          isListening = false;
          micButton.textContent = '🎤 Aufnahme starten';
        }

        if (SpeechRecognition) {
          recognition = new SpeechRecognition();
          recognition.lang = 'de-DE';
          recognition.interimResults = false;
          recognition.continuous = false;

          recognition.addEventListener('result', handleRecognitionResult);
          recognition.addEventListener('error', function (event) {
            logMessage('error', 'Mikrofonfehler: ' + event.error);
            setAvatarState('idle');
            stopListening();
          });

          recognition.addEventListener('end', function () {
            if (isListening) {
              stopListening();
            }
            if (avatar.dataset.state === 'listening') {
              setAvatarState('idle');
            }
          });

          micButton.addEventListener('click', function () {
            if (isListening) {
              stopListening();
            } else {
              startListening();
            }
          });
        } else {
          micButton.disabled = true;
          micButton.textContent = 'Mikrofon nicht verfügbar';
          logMessage('error', 'Die Spracherkennung wird von diesem Browser nicht unterstützt. Bitte nutze die Texteingabe.');
        }

        function requestVrSession() {
          if (!vrScene || typeof vrScene.enterVR !== 'function') {
            logMessage('error', 'VR-Szene ist noch nicht bereit.');
            return;
          }
          try {
            const result = vrScene.enterVR();
            if (result && typeof result.catch === 'function') {
              result.catch(function (error) {
                const reason = error && error.message ? error.message : error;
                logMessage('error', 'VR konnte nicht gestartet werden: ' + reason);
              });
            }
          } catch (error) {
            const reason = error && error.message ? error.message : error;
            logMessage('error', 'VR konnte nicht gestartet werden: ' + reason);
          }
        }

        if (vrButton) {
          if (!(navigator.xr && navigator.xr.isSessionSupported)) {
            vrButton.disabled = true;
            vrButton.textContent = 'VR wird von diesem Gerät nicht unterstützt';
          } else {
            navigator.xr
              .isSessionSupported('immersive-vr')
              .then(function (supported) {
                if (!supported) {
                  vrButton.disabled = true;
                  vrButton.textContent = 'VR wird von diesem Gerät nicht unterstützt';
                }
              })
              .catch(function (error) {
                console.warn('Konnte VR-Unterstützung nicht prüfen:', error);
              });
          }
        }

        if (vrButton && vrScene) {
          const attachVrHandler = function () {
            vrButton.addEventListener('click', requestVrSession);
          };

          if (vrScene.hasLoaded) {
            attachVrHandler();
          } else {
            vrScene.addEventListener('loaded', attachVrHandler, { once: true });
          }
        }

        if (vrScene) {
          vrScene.addEventListener('enter-vr', function () {
            updateVrLog('assistant', 'VR-Modus aktiviert. Willkommen in der Archivator-Kuppel.');
          });
          vrScene.addEventListener('exit-vr', function () {
            updateVrLog('assistant', 'VR-Modus verlassen. Bis bald!');
            updateVrState(avatar.dataset.state || 'idle');
          });
        }

        textForm.addEventListener('submit', function (event) {
          event.preventDefault();
          const value = textInput.value.trim();
          if (!value) {
            return;
          }
          sendToServer(value);
          textInput.value = '';
        });

        if ('speechSynthesis' in window) {
          function updateVoice() {
            const voice = chooseVoice();
            if (voice) {
              selectedVoice = voice;
              logMessage('assistant', 'Ich nutze die Stimme "' + voice.name + '" für Antworten.');
            }
          }

          window.speechSynthesis.onvoiceschanged = function () {
            updateVoice();
          };

          // Attempt immediate loading for browsers that already have the voices list.
          setTimeout(updateVoice, 0);
        } else {
          logMessage('error', 'Die Sprachausgabe wird von diesem Browser nicht unterstützt.');
        }
      })();
    </script>
  </body>
</html>
